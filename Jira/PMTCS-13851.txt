-- Field value miss match
===============================
AC_Count = # in Pack
AC_Volume = Size
AC_Form = Form
===============================
-- On SQL13
------------
select OriginalFlyerID circ_i , OriginalPageDetailID adc_i, ACAdCompBrandId adcompbrand_i, AC_Count, AC_Volume, AC_Form 
Into tempdb.dbo.MilPEPIRIDetailReports_QC
from MilPEPIRIDetailReports with (nolock)

Use tempdb
Go

Create Procedure PRC_Milpepiri_Manual
As
Begin
	If Exists(Select Name From Tempdb.sys.sysobjects where name = 'MilPEPIRIDetailReports_QC')
		Drop Table tempdb.dbo.MilPEPIRIDetailReports_QC

	select	OriginalFlyerID circ_i , OriginalPageDetailID adc_i, ACAdCompBrandId adcompbrand_i,
			AC_Count, AC_Volume, AC_Form 
	Into tempdb.dbo.MilPEPIRIDetailReports_QC
	from SQL13.dbo.MilPEPIRIDetailReports with (nolock)
End

------------------
-- Robin Script
------------------

IF Exists (select Name From tempdb.sys.sysobjects where name = 'MilPEPIRIDetailReports_QC' and type= 'U')
	Drop Table tempdb.dbo.MilPEPIRIDetailReports_QC

select *
Into tempdb.dbo.MilPEPIRIDetailReports_QC
from MT2sql13.tempdb.dbo.MilPEPIRIDetailReports_QC

Alter table tempdb.dbo.MilPEPIRIDetailReports_QC Add AC_Count_new varchar(20)
Alter table tempdb.dbo.MilPEPIRIDetailReports_QC Add AC_Volume_new varchar(20)
Alter table tempdb.dbo.MilPEPIRIDetailReports_QC Add AC_Form_new varchar(20)

-- Updating a new values
update b
	set AC_volume_new = CASE
		WHEN acb.size_1 > 0 AND acb.size_2 > 0 THEN
			CONVERT(VARCHAR, acb.size_1) + '-' + CONVERT(VARCHAR, acb.size_2) + ' ' + 
				case when s2.volume = '***' then s.volume else COALESCE(s.volume,s2.volume) end --size range
		WHEN acb.size_1 > 0 AND acb.size_3 > 0 THEN CONVERT(VARCHAR, acb.size_1) + ' ' + s2.volume
		WHEN acb.size_1 > 0 THEN CONVERT(VARCHAR, acb.size_1) + ' ' + s.volume END ,
	AC_count_new = CASE WHEN acb.size_1 > 0 AND size_3 > 0 and acb.size_4=0 THEN CONVERT(VARCHAR, acb.size_3) + ' ' + s.[count]  
		WHEN acb.size_1 > 0 AND acb.size_2 > 0 and acb.size_4=0 THEN CONVERT(VARCHAR, acb.size_1) + '-' + CONVERT(VARCHAR, acb.size_2) + ' ' + s.[count]
		WHEN acb.size_3 > 0 and acb.size_4 > 0 THEN CONVERT(VARCHAR, acb.size_3) + '-' + CONVERT(VARCHAR, acb.size_4) + ' ' + s.[count]
		WHEN acb.size_1 > 0 THEN CONVERT(VARCHAR, acb.size_1) + ' ' + s.[count] END,
	AC_form_new = case when s.form is null then '' else s.form end 
FROM adcentry.dbo.adCompbrand acb
join tempdb.dbo.MilPEPIRIDetailReports_QC b on acb.adc_i = b.adc_i and acb.adcompbrand_i = b.adcompbrand_i
INNER JOIN adcentry.dbo.ad_sizeunit s ON acb.size_unit_i = s.size_unit_i
INNER JOIN adcentry.dbo.ad_sizeunit s2 ON acb.size_unit_2_i = s2.size_unit_i
where size_nm <> 'size undeterminable'

-- Set miss match circulars for Repull
Insert into robin.ACFV.dbo.updated_adblock
Select Distinct Circ_i, Adc_i
from tempdb.dbo.MilPEPIRIDetailReports_QC
where (ISNULL(ac_count,'') <> ISNULL(ac_count_new,'') Or 
ISNULL(ac_volume,'') <> ISNULL(ac_volume_new,'') Or 
ISNULL(ac_form,'') <> ISNULL(ac_form_new,''))
