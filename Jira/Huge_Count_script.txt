Use ACFVINCR
Go

Declare @StepName varchar(500) = 'Fix huge data count'
Declare @StepStatus int = (Select StepStatus from MasterACFV.dbo.PackageStepDetail with(nolock) where StepName = @StepName)

IF(@StepStatus = 0)
Begin
   If(DATENAME(WEEKDAY,GETDATE()) not in('Friday','Saturday'))
   Begin
		Declare @Expectedcount_1 bigint	,@Expectedcount_2 bigint,@Expectedcount_3 bigint,@Expectedcount_4 bigint ,@Expectedcount bigint
		set @Expectedcount_1 = (select count(pagedetailid) from tempdb.dbo.PDTIDACDetailReports_1)
		set @Expectedcount_2 = (select count(pagedetailid) from tempdb.dbo.PDTIDACDetailReports_2)
		set @Expectedcount_3 = (select count(pagedetailid) from tempdb.dbo.PDTIDACDetailReports_3)
		set @Expectedcount_4 = (select count(pagedetailid) from tempdb.dbo.PDTIDACDetailReports_4)
		set @Expectedcount = @Expectedcount_1 + @Expectedcount_2 +@Expectedcount_3 + @Expectedcount_4

		IF (@Expectedcount > 30000000)
		Begin
			Declare @LastDate Date = (GETDATE()-365)
			
			If Exists(Select Name From ACFVINCR.sys.sysobjects where name = 'Circular_PDT_Delete' )
				Drop Table ACFVINCR..Circular_PDT_Delete
			
			select  Distinct a.FlyerId circ_i, a.adc_i
			Into ACFVINCR..Circular_PDT_Delete
			from  ACFVINCR..ACDetailReports_1 a join ACFVINCR..ACFlyerReports_1 b
			on a.flyerid = b.FlyerId
			where b.Addate <= @LastDate

			Insert Into ACFVINCR..Circular_PDT_Delete(circ_i, adc_i)
			select  Distinct a.FlyerId a_circ_i, a.adc_i
			from  ACFVINCR..ACDetailReports_2 a join ACFVINCR..ACFlyerReports_2 b
			on a.flyerid = b.FlyerId
			where b.Addate <= @LastDate

			Insert Into ACFVINCR..Circular_PDT_Delete(circ_i, adc_i)
			select  Distinct a.FlyerId a_circ_i, a.adc_i
			from  ACFVINCR..ACDetailReports_3 a join ACFVINCR..ACFlyerReports_3 b
			on a.flyerid = b.FlyerId
			where b.Addate <= @LastDate

			Insert Into ACFVINCR..Circular_PDT_Delete(circ_i, adc_i)
			select  Distinct a.FlyerId a_circ_i, a.adc_i
			from  ACFVINCR..ACDetailReports_4 a join ACFVINCR..ACFlyerReports_4 b
			on a.flyerid = b.FlyerId
			where b.Addate <= @LastDate

			Delete a
			From ACFVINCR..ACDetailReports_1 a Join ACFVINCR..Circular_PDT_Delete b
			On a.Flyerid = b.Circ_i

			Delete a
			From ACFVINCR..ACDetailReports_2 a Join ACFVINCR..Circular_PDT_Delete b
			On a.Flyerid = b.Circ_i

			Delete a
			From ACFVINCR..ACDetailReports_3 a Join ACFVINCR..Circular_PDT_Delete b
			On a.Flyerid = b.Circ_i

			Delete a
			From ACFVINCR..ACDetailReports_4 a Join ACFVINCR..Circular_PDT_Delete b
			On a.Flyerid = b.Circ_i

			Delete a
			from ACFVINCR..TempACFVPDTDelete  a
			join ACFVINCR..Circular_PDT_Delete b on a.OriginalPagedetailid = b.adc_i
		
		End
		
   End

    Update MasterACFV.dbo.PackageStepDetail SET StepStatus = 1 Where StepName = @StepName
End