--## change in create page detail ID procedure # pep trigger load

use MasterMappingTables
go

select Pagedetailid, brand_i, TypeId, ACRetMktId, Categoryid, RetMktId
									from tempdb.dbo.PDTIDACDetailReports_1
									where PageDetailID_where is null and Retmktid is not null

select top 4 * from MasterMapPageDetailID with (nolock) where OriginalPageDetailID in ('436619426','461526592')
select top 4 * from tempdb.dbo.PDTIDACDetailReports_1 dt with (nolock) where dt.PageDetailID_where is null

select mp.OriginalPageDetailID, mp.PageDetailID, PageDetailID_where, mp.RetMktID, dt.PageDetailID_where
from tempdb.dbo.PDTIDACDetailReports_1 dt with (nolock)
	join MasterMappingTables..MasterMapPageDetailID mp with (nolock)
on mp.OriginalPageDetailID = CONVERT( varchar(20), dt.Pagedetailid) and mp.ACRetMktId = dt.ACRetMktid
and mp.MadCode =  dt.brand_i and mp.RetMktID = dt.retmktid and mp.ACCatId = dt.Categoryid
and mp.TypeId = 1
where dt.PageDetailID_where is null and mp.OriginalPageDetailID = 426921102


select retmktid, * from ACFVINCR..TempACFVDetailReports_1 where ACAdCompBrandId = 426921102

#############################Test#################################
-- Before changes

Select Distinct MPDTID.pagedetailid,ACDR.adc_i as originalpagedetailid,pr.flyerid ,pr.originalflyerid ,pr.page ,pr.pagetype 
from acfvincr.dbo.TempACFVPageReports_1 pr with (nolock)
join acfvincr.dbo.ACDetailReports_1 ACDR with (nolock)
	on pr.OriginalFlyerID = ACDR.FlyerId and pr.page = ACDR.page and pr.ACpage = ACDR.ACpage
join MasterMappingTables..MasterMapPageDetailID MPDTID with (nolock)
	on Convert(varchar(20),ACDR.Pagedetailid) = MPDTID.OriginalPageDetailID
and pr.retmktid = MPDTID.RetmktId
And ACDR.Brand_i = MPDTID.MadCode
And ISNULL(ACDR.categoryid,'') = ISNULL(MPDTID.ACCatId,'')
and MPDTID.TypeId = 1 

-- After change
Select Distinct MPDTID.pagedetailid_where,
		ACDR.adc_i as originalpagedetailid,
		pr.flyerid ,pr.originalflyerid ,pr.page ,pr.pagetype 
from acfvincr.dbo.TempACFVPageReports_1 pr with (nolock)
join acfvincr.dbo.ACDetailReports_1 ACDR with (nolock)
on pr.OriginalFlyerID = ACDR.FlyerId
and pr.page = ACDR.page
and pr.ACpage = ACDR.ACpage
join tempdb.dbo.PDTIDACDetailReports_1_Test MPDTID with (nolock)
on Convert(varchar(20),ACDR.Pagedetailid) = MPDTID.pagedetailid 
and pr.retmktid = MPDTID.RetmktId
And ACDR.Brand_i = MPDTID.Brand_i
And ISNULL(ACDR.categoryid,'') = ISNULL(MPDTID.categoryid,'')
and MPDTID.TypeId = 1 


###############################################################################################
Test -2  on 08/12/2021
-------
select count(1) from tempdb..PDTIDACDetailReports_1_Test
select count(1) from tempdb..PDTIDACDetailReports_2_Test
select count(1) from tempdb..PDTIDACDetailReports_3_Test
select count(1) from tempdb..PDTIDACDetailReports_4_Test


--select mp.OriginalPageDetailID, mp.PageDetailID, PageDetailID_where, mp.RetMktID, dt.PageDetailID_where
update dt 
set dt.PageDetailID_where = mp.OriginalPageDetailID
from tempdb.dbo.PDTIDACDetailReports_1_Test dt with (nolock)
	join MasterMappingTables..MasterMapPageDetailID mp with (nolock)
on mp.OriginalPageDetailID = CONVERT( varchar(20), dt.Pagedetailid)
and mp.ACRetMktId = dt.ACRetMktid
and mp.MadCode =  dt.brand_i
and mp.RetMktID = dt.retmktid
and mp.ACCatId = dt.Categoryid
and mp.TypeId = 1
where PageDetailID_where is null 

--select mp.OriginalPageDetailID, mp.PageDetailID, PageDetailID_where, mp.RetMktID, dt.PageDetailID_where
update dt 
set dt.PageDetailID_where = mp.OriginalPageDetailID
from tempdb.dbo.PDTIDACDetailReports_2_Test dt with (nolock)
	join MasterMappingTables..MasterMapPageDetailID mp with (nolock)
on mp.OriginalPageDetailID = CONVERT( varchar(20), dt.Pagedetailid)
and mp.ACRetMktId = dt.ACRetMktid
and mp.MadCode =  dt.brand_i
and mp.RetMktID = dt.retmktid
and mp.ACCatId = dt.Categoryid
and mp.TypeId = 1
where PageDetailID_where is null 



--select mp.OriginalPageDetailID, mp.PageDetailID, PageDetailID_where, mp.RetMktID, dt.PageDetailID_where
update dt 
set dt.PageDetailID_where = mp.OriginalPageDetailID
from tempdb.dbo.PDTIDACDetailReports_3_Test dt with (nolock)
	join MasterMappingTables..MasterMapPageDetailID mp with (nolock)
on mp.OriginalPageDetailID = CONVERT( varchar(20), dt.Pagedetailid)
and mp.ACRetMktId = dt.ACRetMktid
and mp.MadCode =  dt.brand_i
and mp.RetMktID = dt.retmktid
and mp.ACCatId = dt.Categoryid
and mp.TypeId = 1
where PageDetailID_where is null 



--select mp.OriginalPageDetailID, mp.PageDetailID, PageDetailID_where, mp.RetMktID, dt.PageDetailID_where
update dt 
set dt.PageDetailID_where = mp.OriginalPageDetailID
from tempdb.dbo.PDTIDACDetailReports_4_Test dt with (nolock)
	join MasterMappingTables..MasterMapPageDetailID mp with (nolock)
on mp.OriginalPageDetailID = CONVERT( varchar(20), dt.Pagedetailid)
and mp.ACRetMktId = dt.ACRetMktid
and mp.MadCode =  dt.brand_i
and mp.RetMktID = dt.retmktid
and mp.ACCatId = dt.Categoryid
and mp.TypeId = 1
where PageDetailID_where is null 



----- Data check 
-- Master
Select Distinct MPDTID.pagedetailid,ACDR.adc_i as originalpagedetailid,pr.flyerid ,pr.originalflyerid ,pr.page ,pr.pagetype 
into tempdb..ACDetailReports_1_Test_Master
from acfvincr.dbo.TempACFVPageReports_1 pr with (nolock)
join acfvincr.dbo.ACDetailReports_1 ACDR with (nolock)
	on pr.OriginalFlyerID = ACDR.FlyerId and pr.page = ACDR.page and pr.ACpage = ACDR.ACpage
join MasterMappingTables..MasterMapPageDetailID MPDTID with (nolock)
	on Convert(varchar(20),ACDR.Pagedetailid) = MPDTID.OriginalPageDetailID
and pr.retmktid = MPDTID.RetmktId
And ACDR.Brand_i = MPDTID.MadCode
And ISNULL(ACDR.categoryid,'') = ISNULL(MPDTID.ACCatId,'')
and MPDTID.TypeId = 1 

-- pDT
Select Distinct MPDTID.pagedetailid_where,
		ACDR.adc_i as originalpagedetailid,
		pr.flyerid ,pr.originalflyerid ,pr.page ,pr.pagetype
into tempdb..ACDetailReports_1_Test_PDT
from acfvincr.dbo.TempACFVPageReports_1 pr with (nolock)
join acfvincr.dbo.ACDetailReports_1 ACDR with (nolock)
on pr.OriginalFlyerID = ACDR.FlyerId
and pr.page = ACDR.page
and pr.ACpage = ACDR.ACpage
join tempdb.dbo.PDTIDACDetailReports_1_Test MPDTID with (nolock)
on Convert(varchar(20),ACDR.Pagedetailid) = MPDTID.pagedetailid 
and pr.retmktid = MPDTID.RetmktId
And ACDR.Brand_i = MPDTID.Brand_i
And ISNULL(ACDR.categoryid,'') = ISNULL(MPDTID.categoryid,'')
and MPDTID.TypeId = 1 

-- find difference count
select * from tempdb..ACDetailReports_1_Test_Master 
where pagedetailid not in (
select pagedetailid_where from tempdb..ACDetailReports_1_Test_PDT)

select * from tempdb..PDTIDACDetailReports_1_test where PageDetailID_where = 872594012

select * from MasterMappingTables..MasterMapPageDetailID with (nolock) where PageDetailID in ( 872594012, 929218864)
select * from MasterMappingTables..MasterMapPageDetailID with (nolock) where originalpagedetailid =  '490756571'
and RetMktID = 3143

select top  5 * from ACFVINCR..TempACFVDetailReports_1 with (nolock) where PageDetailID in ( 872594012, 929218864)

select * from ACFVINCR..ACDetailReports_1 where Pagedetailid =  490756571

select * from ACFVINCR..circular_list where circ_i =  2045588 and market = 'St. Louis, MO'

select *  from MasterMappingTables..REtMKTpep where retailer= 'Family Dollar' and market = 'St. Louis, MO'
select *  from MasterMappingTables..REtMKTpep where  ACRetmktid in (530515, 53054075)


Select	ACDR.Pagedetailid
		, ACDR.brand_i
		, 1 As TypeId
		, RMP.ACRetMktid
		, ACDR.Categoryid
		, RMP.retmktid
		, MMPDTID.PageDetailID  PageDetailID_where
from	ACFVINCR.dbo.ACDetailReports_1 ACDR with(nolock)
JOIN	ACFVINCR.dbo.Circular_list CL with(nolock) On ACDR.Flyerid = CL.Circ_i		
LEFT JOIN	MasterMappingTables.dbo.retmktpep RMP with(nolock) 
				ON CL.Advertiser = RMP.Retailer And Cl.Market = RMP.Market
				And Concat(Convert(varchar(50),CL.retailer_i), Convert(varchar(50),CL.major_city_i)) = Convert(varchar(50),RMP.ACRetmktid)				 
Left Join	MasterMappingTables.dbo.MasterMapPageDetailID MMPDTID with(nolock) 	
				ON MMPDTID.OriginalPageDetailID = Convert(Varchar(20),ACDR.Pagedetailid) 
				And MMPDTID.MadCode = ACDR.brand_i 
				--And MMPDTID.ACRetMktId = RMP.ACRetMktid
				And MMPDTID.RetMktID = RMP.retmktid
				And ISNULL(MMPDTID.ACCatId,'') = ISNULL(ACDR.Categoryid,'') 
				And MMPDTID.TypeId = 1
where circ_i =  2045588
--and MMPDTID.PageDetailID = 929218864
and MMPDTID.Retmktid = 3143 
and ACDR.PageDetailID = 490756571



select originalpagedetailid, MadCode, ACCatId, RetMktID, count(1) 
from MasterMappingTables..MasterMapPageDetailID with (nolock) where originalpagedetailid in 
group by originalpagedetailid, MadCode, ACCatId, RetMktID having count(1)> 1

====================================================================================================
--checking for retailer match code in city
===
use ADCEntry
go

select a.retailer_i, b.city_i, CONVERT(varchar, a.retailer_i) + CONVERT(varchar,b.city_i) acretmktid
from ad_retailers a join city b on retailer_i = city_i 

====================================================================================================
--Delete Checking
-----------------

use MasterMappingTables

select originalpagedetailid, MadCode, ACCatId, RetMktID, count(1) cnt
into tempdb.dbo.MasterMapPageDetailID_Delete
from MasterMappingTables..MasterMapPageDetailID with (nolock) 
where TypeId = 1
group by originalpagedetailid, MadCode, ACCatId, RetMktID having count(1)> 1

--select top 10 * from tempdb.dbo.MasterMapPageDetailID_Delete

select distinct a.ACRetMktId
from MasterMappingTables..MasterMapPageDetailID a with (nolock) 
join tempdb.dbo.MasterMapPageDetailID_Delete b
on a.OriginalPageDetailID = b.OriginalPageDetailID and a.MadCode = b.MadCode
and a.ACCatId = b.ACCatId  and a.RetMktID = b.RetMktID

-- check for missing retail market
select * from MasterMappingTables..MasterMapPageDetailID a with (nolock) 
left join MasterMappingTables..REtMKTpep b with (nolock) 
on a.ACRetMktId = b.ACRetmktid and a.RetMktID = b.Retmktid
where b.ACRetmktid is null and b.Retmktid is null 

-- Duplicate retailer market entry
select originalpagedetailid, MadCode, ACCatId, RetMktID, ACRetMktId, count(1) cnt
from MasterMappingTables..MasterMapPageDetailID with (nolock) 
where TypeId = 1
group by originalpagedetailid, MadCode, ACCatId, RetMktID, ACRetMktId having count(1)> 1

