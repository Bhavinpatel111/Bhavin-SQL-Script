Use SQL13
Go

Declare @StepName varchar(500) = 'Master Pep Missing Weekly AdGrade'
Declare @StepStatus int = (Select StepStatus from MasterACFV.dbo.PackageStepDetail with(nolock) where StepName = @StepName)

IF(@StepStatus = 0)
Begin
	If DATENAME(DW,GETDATE()) = 'FRIDAY'
	Begin
		Begin try
			If Exists(Select Name From Tempdb.sys.sysobjects where name = 'Adgrade_CheckList_Dist' and type='U')
				Drop Table Tempdb..Adgrade_CheckList_Dist

			select Distinct ACAdCompBrandId, Weight
			Into Tempdb..Adgrade_CheckList_Dist
			from MasterACFV..ACFVDetailReports with (nolock)

		    Exec mt2sql14.Master.dbo.mt_proc_send_cdosysmail 
				        @to='Bhavin.patel111@numerator.com;vikas.kantawala@numerator.com;pratik.makwana@numerator.com',
		 		        @subject='Master Pep Weekly AdGrade Table Created On MT2SQL13 and Job triggered on Robin',
				        @BodyType = 'HTML',
				        @Body = 'Master Pep Weekly AdGrade Table Created On MT2SQL13 and Job triggered on Robin'
		end try
		
		begin catch
			select ERROR_MESSAGE() as ERROR_MESSAGE
		end catch
	end

	Update MasterACFV.dbo.PackageStepDetail SET StepStatus = 1 Where StepName = @StepName
End

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

use Tempdb

If Exists(Select Name From Tempdb.sys.sysobjects where name = 'Adgrade_CheckList_Dist' and type='U')
	Drop Table Tempdb..Adgrade_CheckList_Dist

select * Into Tempdb..Adgrade_CheckList_Dist
From mt2sql13.Tempdb.dbo.Adgrade_CheckList_Dist

Alter Table Tempdb..Adgrade_CheckList_Dist Add weight_new Decimal(9,6)

Update a
set a.weight_new = c.total_score
From Tempdb.dbo.Adgrade_CheckList_Dist a join ADCEntry..adcompbrand b
on b.adcompbrand_i = a.acadcompbrandid
join ADCEntry..ad_score_block c on c.adc_i = b.adc_i and c.brand_i = b.brand_i

-- check miss match
select Distinct acadcompbrandid
Into #Adgrade_CheckList_Dist_Updated
from Tempdb.dbo.Adgrade_CheckList_Dist 
where isnull(weight ,0) <> isnull(weight_new,0)


Insert Into ACFV..updated_Adblock_Parked
select Distinct a.circ_i,c.adc_i, GetDate()
from robin.adcentry.dbo.adCircular a with(nolock)
join robin.ADCEntry.dbo.adCircularPg b with(nolock) on a.circ_i = b.circ_i
join robin.ADCEntry.dbo.adCompare c  with(nolock) on b.circ_pg_i = c.circ_pg_i
join robin.ADCEntry.dbo.adcompbrand d with(nolock) on d.adc_i = c.adc_i
Join #Adgrade_CheckList_Dist_Updated e with(nolock) on d.adcompbrand_i = e.acadcompbrandid

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

case when ISNULL(ACDR.weight,0) < 22 then ''Satisfactory''
	when ISNULL(ACDR.weight,0) between 22 and 78 then ''Competitive''
	when ISNULL(ACDR.weight,0) > 78 then ''Excellent''  end as ACAdGrade


-- Robin

select a.start_dt,a.circ_week_dt,  asb.*
from robin.adcentry.dbo.adCircular a with(nolock)
join robin.ADCEntry.dbo.adCircularPg b with(nolock) on a.circ_i = b.circ_i
join robin.ADCEntry.dbo.adCompare c  with(nolock) on b.circ_pg_i = c.circ_pg_i
join robin.ADCEntry.dbo.adcompbrand d with(nolock) on d.adc_i = c.adc_i
Join ADCEntry.dbo.ad_score_block ASB with (nolock) on c.adc_i = ASB.adc_i and d.brand_i = ASB.brand_i
where c.adc_i in (358498674,404115704)

------------------

select convert(date, create_dt), count(distinct adc_i) 
from ADCEntry..ad_score_block where year(create_dt) = '2022'
Group by convert(date, create_dt)

====================================================
SQL13
------------
use MasterACFV

If Exists(Select Name From Tempdb.sys.sysobjects where name = 'Adgrade_CheckList_Dist' and type='U')
	Drop Table Tempdb..Adgrade_CheckList_Dist

select distinct ACAdCompBrandId, Weight
Into Tempdb..Adgrade_CheckList_Dist
from MasterACFV..ACFVDetailReports with (nolock)


--------------------------------------------------
-- Robin
---------
If Exists(Select Name From Tempdb.sys.sysobjects where name = 'Adgrade_CheckList_Dist' and type='U')
	Drop Table Tempdb..Adgrade_CheckList_Dist

select * Into Tempdb..Adgrade_CheckList_Dist
From mt2sql13.Tempdb.dbo.Adgrade_CheckList_Dist

--Alter Table Tempdb..Adgrade_CheckList_Dist Add weight_new Float
Alter Table Tempdb..Adgrade_CheckList_Dist Add weight_new Decimal(9,6)

--select top 4  * from ADCEntry..ad_score_block where adc_i in (358498674,404115704) 
use tempdb

Update a
set a.weight_new = c.total_score
From Tempdb.dbo.Adgrade_CheckList_Dist a join ADCEntry..adcompbrand b
on b.adc_i = a.adc_i and  b.adcompbrand_i = a.acadcompbrandid
join ADCEntry..ad_score_block c on c.adc_i = b.adc_i and c.brand_i = b.brand_i


Update a
set a.weight_new = c.total_score
From Tempdb.dbo.Adgrade_CheckList_Dist a join ADCEntry..adcompbrand b
on b.adcompbrand_i = a.acadcompbrandid
join ADCEntry..ad_score_block c on c.adc_i = b.adc_i and c.brand_i = b.brand_i

-- check miss match

select *
Into Tempdb.dbo.Adgrade_CheckList_Dist_Updated
from Tempdb.dbo.Adgrade_CheckList_Dist 
where isnull(weight ,0) <> isnull(weight_new,0)


Alter table Tempdb.dbo.Adgrade_CheckList_Dist_Updated Add AdGrade varchar(50)


Update Tempdb.dbo.Adgrade_CheckList_Dist_Updated
Set AdGrade = case when ISNULL(weight_new,0) < 22 then 'Satisfactory'
	when ISNULL(weight_new,0) between 22 and 78 then 'Competitive'
	when ISNULL(weight_new,0) > 78 then 'Excellent'  end 
where weight_new is not null 

========================================================================================================
SQL13
-------------
-- Copy Table 
select *
Into Tempdb.dbo.Adgrade_CheckList_Dist_Updated
from Robin.Tempdb.dbo.Adgrade_CheckList_Dist_Updated


select a.*, b.PageDetailID
Into Tempdb.dbo.Adgrade_CheckList_Dist_Updated_New
From Tempdb.dbo.Adgrade_CheckList_Dist_Updated a
join  MasterMappingTables..MasterMapPageDetailID b on b.OriginalPageDetailID = CONVERT(varchar, a.acadcompbrandid)

Drop Table If Exists Tempdb.dbo.Adgrade_UpdateFinal

Select PagedetailId, Weight_new, AdGrade
Into Tempdb.dbo.Adgrade_UpdateFinal
From Tempdb.dbo.Adgrade_CheckList_Dist_Updated_New 


===========================================================================================
-- Update Master Data for All Server
===========================================================================================
Select *
Into Tempdb.dbo.Adgrade_UpdateFinal
From mT2SQL13.Tempdb.dbo.Adgrade_UpdateFinal
------------------------------------


Use ACFVINCR

Declare @Cnt Bigint = 1 

While (@cnt > 0 )
Begin
	Drop Table If Exists #Adgrade_UpdateFinal_TMP

	Select Top 100000 * Into #Adgrade_UpdateFinal_TMP
	From Tempdb.dbo.Adgrade_UpdateFinal

	Update a
	Set a.ACAdGrade = b.AdGrade, a.Weight = b.Weight_new
	From MasterACFV..ACFVDetailReports a Join #Adgrade_UpdateFinal_TMP b
	On a.Pagedetailid = b.Pagedetailid

	Delete a
	From Tempdb.dbo.Adgrade_UpdateFinal a Join #Adgrade_UpdateFinal_TMP b
	On a.Pagedetailid = b.Pagedetailid

	Set @cnt  = (Select Count(1)From Tempdb.dbo.Adgrade_UpdateFinal)

	Print  @cnt
End


-----------------------------------------
Client Updates
--------------

use sql13

Select Name, 'Update a Set a.ACAdGrade = b.AdGrade, a.Weight = b.Weight_new From '
	+ Name + ' a Join Tempdb.dbo.Adgrade_UpdateFinal b On a.Pagedetailid = b.Pagedetailid
	where Dtadded < ''2022-03-10 00:00:00.000'''
from sys.sysobjects where name like '%Detailreports' and type='U'
and name not like '%Export%'


-------------------------------------

Use ACFVINCR

Drop Table If Exists #Adgrade_UpdateFinal_ALL

Select * Into #Adgrade_UpdateFinal_ALL From Tempdb.dbo.Adgrade_UpdateFinal

Declare @Cnt Bigint = 1 

While (@cnt > 0 )
Begin
	Drop Table If Exists #Adgrade_UpdateFinal_TMP

	Select Top 1000000 * Into #Adgrade_UpdateFinal_TMP
	From #Adgrade_UpdateFinal_ALL

	Update a
	Set a.ACAdGrade = b.AdGrade, a.Weight = b.Weight_new
	From Pep00..cccacDetailReports a Join #Adgrade_UpdateFinal_TMP b
	On a.Pagedetailid = b.Pagedetailid

	Delete a
	From #Adgrade_UpdateFinal_ALL a Join #Adgrade_UpdateFinal_TMP b
	On a.Pagedetailid = b.Pagedetailid

	Set @cnt  = (Select Count(1)From #Adgrade_UpdateFinal_ALL)

	Print  @cnt
End

